# Redux Toolkit Query (RTK Query)

RTK QueryëŠ” â€œì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê³ (ì¡°íšŒÂ·ìˆ˜ì •) **ìë™ìœ¼ë¡œ ìºì‹œí•˜ê³  ë™ê¸°í™”**í•´ì£¼ëŠ” ë„êµ¬â€ì…ë‹ˆë‹¤.  
ì¦‰, `fetch/axios` + `createAsyncThunk` + ì—¬ëŸ¬ `slice`ë¡œ í•˜ë˜ ê·€ì°®ì€ ë°˜ë³µì„ í›…ê³¼ ì„ ì–¸ë§Œìœ¼ë¡œ í•´ê²°í•´ì¤ë‹ˆë‹¤.

--

## 1ï¸âƒ£ ì¥ì  (ë‹¨ìˆœí•¨)

- APIë¥¼ í•˜ë‚˜ì˜ ëª¨ë“ˆ(apiSlice)ì— ì„ ì–¸
- ì„ ì–¸í•œ ì—”ë“œí¬ì¸íŠ¸ë§ˆë‹¤ **ìë™ìœ¼ë¡œ React** í›…ì´ ìƒì„± (`useGetTodosQuery`)
- í›…ì„ ì“°ë©´ **ë°ì´í„°, ë¡œë”©, ì—ëŸ¬ ìƒíƒœ**ê°€ ìë™ìœ¼ë¡œ ì œê³µ
- ê°™ì€ ì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì“°ë©´ **ìºì‹œë¥¼ ê³µìœ **í•´ì„œ ì¤‘ë³µ ìš”ì²­ì„ ë§‰ìŒ
- ë°ì´í„° ë³€ê²½(POST/PUT/DELETE)ì€ **íƒœê·¸(tag)**ë¥¼ í†µí•´ ê´€ë ¨ ì¿¼ë¦¬ë¥¼ ìë™ì„ ìƒˆë¡œê³ ì¹¨(ë¬´íš¨í™”)

---

## 2ï¸âƒ£ ê¸°ë³¸ ê°œë… ìš”ì•½

- **API slice**: `createApi`ë¡œ ë§Œë“  ëª¨ë“ˆ. ì—”ë“œí¬ì¸íŠ¸ë“¤ì„ ëª¨ì•„ë‘ 
- **query**:GET ê³„ì—´, ìºì‹œ ê°€ëŠ¥í•œ ì¡°íšŒ
- **mutation**: POST/PUT/DELETE ê°™ì€ ë³€ê²½ ìš”ì²­, ìºì‹œ ë¬´íš¨í™” íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ê´€ë ¨ ì¿¼ë¦¬ ê°±ì‹ 
- **tags**: ë¦¬ì†ŒìŠ¤ ë¼ë²¨ - ì–´ë–¤ mutationì´ ì–´ë–¤ queryë¥¼ invalildates/provides í•˜ëŠ”ì§€ ì—°ê²°
- **fetchBaseQuery**: ë‚´ë¶€ì ìœ¼ë¡œ `fetch`ë¥¼ ë˜í•‘í•œ ê¸°ë³¸ baseQuery. ê°„ë‹¨í•œ APIì—” ì´ê±¸ ì‚¬ìš©
- **munual refetch / laze query**: í•„ìš” ì‹œ ì‹¤í–‰í•˜ëŠ” ì¿¼ë¦¬ (ìë™ ì‹¤í–‰ì´ ì•„ë‹ˆë¼ í›… í˜¸ì¶œ ì œì–´)
- **optimistic updates**: ì„œë²„ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¥¼ ë¨¼ì € ì—…ë°ì´íŠ¸

---

## 3ï¸âƒ£ ê¸°ë³¸ ì‚¬ìš© ì˜ˆì œ - `createApi`ì™€ ì—”ë“œí¬ì¸íŠ¸

### ğŸ“„ apiSlice.js

```js
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";

export const api = createApi({
  reducerPath: "api",
  baseQuery: fetchBaseQuery({
    baseUrl: "/api",
    prepareHeaders: (headers, { getState }) => {
      const token = getState().auth.token;
      if (token) headers.set("authorization", `Bearer ${token}`);
      return headers;
    },
  }),
  tagTypes: ["User", "Todo"],
  endpoints: (builder) => ({
    // ì‚¬ìš©ì ì¡°íšŒ
    getUser: builder.query({
      query: (id) => `/user/${id}`,
      providesTags: (result, error, id) => [{ type: "User", id }],
    }),

    // Todo ì¡°íšŒ
    getTodos: builder.query({
      query: () => "/todos",
      providesTags: (result) =>
        result
          ? [
              ...result.map((r) => ({ type: "Todo", id: r.id })),
              { type: "Todo", id: "LIST" },
            ]
          : [{ type: "Todo", id: "LIST" }],
    }),

    // Todo ì¶”ê°€
    addTodo: builder.mutation({
      query: (newTodo) => ({
        url: "/todos",
        method: "POST",
        body: newTodo,
      }),
      invalidatesTags: [{ type: "Todo", id: "LIST" }],
    }),

    // Todo done í† ê¸€
    toggleTodo: builder.mutation({
      query: ({ id, done }) => ({
        url: `/todos/${id}`,
        method: "PATCH",
        body: { done },
      }),
      invalidatesTags: (result, error, { id }) => [{ type: "Todo", id }],
    }),
  }),
});

export const {
  useGetUserQuery,
  useGetTodosQuery,
  useAddTodoMutation,
  useToggleTodoMutation,
} = api;

```

#### `createApi`

- APIë¥¼ ì •ì˜í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
- reducer + middleware ìë™ ìƒì„±

#### `baseQuery`

- ëª¨ë“  fetch ìš”ì²­ì˜ ê³µí†µ ì„¤ì •
- ì˜ˆ: baseUrl, í—¤ë”, í† í° ì„¤ì • ë“±

#### `endpoints`

- GET, POST, PATH ë“± ì‹¤ì œ API ìš”ì²­ ì •ì˜
- `query` â†’ GET
- `mutation` â†’ POST / PATCH / DELETE ë“±

#### Tag ê¸°ë°˜ ìºì‹œ ê´€ë¦¬

- `providesTags` â†’ ë°ì´í„°ê°€ ì œê³µí•˜ëŠ” íƒœê·¸ (ìºì‹œë¥¼ ì €ì¥í•  ë•Œ ë¶™ì´ëŠ” ë¼ë²¨)
- `invalidatesTags` â†’ ì´ íƒœê·¸ë¥¼ ê°€ì§„ ìºì‹œë¥¼ ë¬´íš¨í™” â†’ ìë™ ì¬ìš”ì²­ (ë°ì´í„°ê°€ ë³€í™”ë˜ì–´ ë‹¤ì‹œ ìš”ì²­í•˜ë„ë¡ í•˜ëŠ” ì‹ í˜¸)

#### Auto Hooks ìƒì„±

- `useGetTodosQuery`
- `useAddTodoMutation`
- ìë™ ìƒì„±ë˜ëŠ”ê²Œ RTK Queryì˜ í° ì¥ì 

---
 
### ğŸ“„ store ì„¤ì •

```js
import { configureStore } from "@reduxjs/toolkit";
import { api } from "./apiSlice";
import authReducer from "./authSlice";

const store = configureStore({
  reducer: {
    [api.reducerPath]: api.reducer,
    auth: authReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(api.middleware),
});

export default store;

```

---

## 4ï¸âƒ£ Reactì—ì„œ í›… ì‚¬ìš© ì˜ˆì‹œ

```jsx
function TodoList() {
  const { data: todos, error, isLoading, refetch } = useGetTodosQuery();
  const [addTodo] = useAddTodoMutation();

  if (isLoading) return <div>ë¡œë”©ì¤‘â€¦</div>;
  if (error) return <div>ì—ëŸ¬: {error.toString()}</div>;

  return (
    <div>
      <button onClick={() => refetch()}>ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨</button>
      <ul>
        {todos.map((t) => (
          <li key={t.id}>
            {t.text}
            <button onClick={() => addTodo({ text: "ìƒˆ í• ì¼" })}>ì¶”ê°€</button>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

- `useGet{}Query`ëŠ” mount ì‹œ ìë™ ìš”ì²­(ìë™ ìºì‹±)
- `refetch()`ë¡œ ìˆ˜ë™ ì¬ìš”ì²­ ê°€ëŠ¥
- `use{}}Mutation`ì€ `[triggerFn, {status...}]` í˜•íƒœë„ ê°€ëŠ¥ (`const [addTodo, result] = useAddTopdoMutation()`)

---

## 5ï¸âƒ£ Tag ê¸°ë°˜ ìºì‹œ ë¬´íš¨í™” (provides/invalidates)

- Queryì—ì„œ `providesTags`ë¡œ ì–´ë–¤ íƒœê·¸ë¥´ ì œê³µ(provide)í• ì§€ ì„ ì–¸
- Mutationdã…”ì„œ `invalidatesTags`ë¡œ ì–´ë–¤ íƒœê·¸ë¥¼ ë¬´íš¨í™”(invalidate)í• ì§€ ì„ ì–¸
- ê²°ê³¼: í•´ë‹¹ íƒœê·¸ë¥¼ ì œê³µí•˜ë˜ ì¿¼ë¦¬ê°€ ìë™ ë¦¬íŒ¨ì¹˜ë˜ì–´ ìµœì‹  ë°ì´í„° ìœ ì§€

### ğŸ”¹ ì˜ˆì‹œ íŒ¨í„´

- ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ â†’ `provides: [{ type: 'Todo', id: 'LIST' }]`
- í•­ëª© ìƒì„±/ì‚­ì œ â†’ `invalidates: [{ type: 'Todo', id: 'LIST' }]`
- í•­ëª© ì—…ë°ì´íŠ¸ â†’ `invalidates: [{ typeL 'Todo',  id: 'itemId' }]`

ì´ íŒ¨í„´ì„ ì¼ê´€ë˜ê²Œ ì ìš©í•˜ë©´ ìˆ˜ë™ ìƒíƒœ ì¡°ì‘ ì—†ì´ë„ ì„œë²„-í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

##  6ï¸âƒ£ Optimistic Update (ë‚™ê´€ì  ì—…ë°ì´í„°) 

ì„œë²„ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  UIë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ `updateQueryData`ì™€ `path`ë¥¼ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.

### ğŸ§ ì˜ˆì‹œ: ì²´í¬ë°•ìŠ¤ í† ê¸€ ë‚™ê´€ ì—…ë°ì´íŠ¸

```tsx
// ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€
const [toggleTodo] = useToggleTodoMutation();
const patchResult = api.util.updateQueryData('getTodos', undefined, (draft) => {
  const todo = draft.find(t => t.id === id);
  if (todo) todo.done = !todo.done;
});

try {
  const res = await toggleTodo({ id, done: !currentDone }).unwrap();
  // ì„±ê³µ ì‹œ ì•„ë¬´ ì‘ì—… í•„ìš” ì—†ìŒ (ì„œë²„ ì‘ë‹µì— ë”°ë¼ ìºì‹œê°€ ì´ë¯¸ ê°±ì‹ ë  ìˆ˜ë„)
} catch (err) {
  patchResult.undo(); // ì‹¤íŒ¨í•˜ë©´ ë¡¤ë°±
}
```

- `unwarp()`ì„ ì“°ë©´ rejectionì„ try/catchë¡œ ì¡ì•„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
- `pathchResult.undo()`ë¥¼ í˜¸ì¶œí•˜ë©´ ë‚™ê´€ ì—…ë°ì´íŠ¸ë¥¼ ë¡¤ë°± ê°€ëŠ¥
- ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ ë™ì‹œì— ìˆ˜ì •í•´ì•¼ í•˜ë©´ `dispatch(api.util.undateQueryDate(...))` íŒ¨í„´ì„ ì‚¬ìš©

---

## 7ï¸âƒ£ Lazy Query, Polling, Re-fetch ì „ëµ

- **Lazy queries**: `useLazyQuery` í˜¹ì€ ì‚¬ìš©í•˜ë©´ í•„ìš”í•  ë•Œë§Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰

```tsx
const [trigger, result] = useLazyGetUserQuery();
// trigger(userId) ë¡œ ì‹¤í–‰
```

- **Polling**: ìë™ìœ¼ë¡œ ì£¼ê¸°ì  ì¬ìš”ì²­. ì¿¼ë¦¬ ì˜µì…˜ì—ì„œ `pollingInterval` ì‚¬ìš©

```jsx
useGetTodosQuery(undefined, { pollingInterval: 10000 }); // 10ì´ˆë§ˆë‹¤ ê°±ì‹ 
```

- **Refetch on Focus / Reconnect**: `setupListeners`ì™€ í•¨ê»˜ `refetchOnFocus: true`, `refetchOnReconnect: true`ë¥¼ ì‚¬ìš©í•˜ë©´ ë¸Œë¼ìš°ì € í¬ì»¤ìŠ¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ ìë™ ì¬ìš”ì²­

```jsx
import { setupListeners } from "@reduxjs/toolkit/query";
setupListeners(store.dispatch);
```

---